name: Update README with gource video (with SHA)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write   # ðŸ‘ˆ necesario para poder hacer commit/push al repo

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4   # versiÃ³n mÃ¡s reciente

      - name: Update README with githack production URL
        run: |
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY##*/}"
          SHA="${GITHUB_SHA}"
          FILE="gource.mp4"

          URL="https://rawcdn.githack.com/$OWNER/$REPO/$SHA/$FILE"

          echo "Generated URL: $URL"

          START="<!-- GOURCE-VIDEO-START -->"
          END="<!-- GOURCE-VIDEO-END -->"

          if grep -q "$START" README.md; then
            sed -i "/$START/,/$END/c\\$START\n[Ver gource.mp4]($URL)\n$END" README.md
          else
            echo -e "\n$START\n[Ver gource.mp4]($URL)\n$END" >> README.md
          fi

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Update gource.mp4 link in README with commit SHA" || echo "No changes to commit"
          git push
